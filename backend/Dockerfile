# Etapa 1: Build
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /app

# Copiar archivos de configuraci贸n de Maven
COPY pom.xml .

# Descargar dependencias (se cachea si pom.xml no cambia)
RUN mvn dependency:go-offline -B

# Copiar c贸digo fuente
COPY src ./src

# Compilar la aplicaci贸n
RUN mvn clean package -DskipTests

# Etapa 2: Runtime
FROM eclipse-temurin:17-jre-alpine

# Crear usuario no privilegiado
RUN addgroup -g 1001 -S appuser && \
    adduser -u 1001 -S appuser -G appuser

WORKDIR /app

# Copiar el JAR compilado desde la etapa de build
COPY --from=build /app/target/*.jar app.jar

# Dar permisos al usuario no privilegiado
RUN chown -R appuser:appuser /app

# Cambiar a usuario no privilegiado
USER appuser

# Exponer el puerto (ajusta si tu app usa otro puerto)
EXPOSE 3001

# Variables de entorno (se pueden sobrescribir en docker-compose)
ENV JAVA_OPTS=""

# Comando para ejecutar la aplicaci贸n
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
